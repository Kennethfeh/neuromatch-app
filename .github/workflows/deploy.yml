name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: ap-southeast-2
  ECR_REPOSITORY: neuromatch-api
  EKS_CLUSTER_NAME: neuromatch-cluster

permissions:
  contents: read
  security-events: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm test

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run Trivy
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-results.sarif
      - uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif

  build:
    name: Build Docker image
    runs-on: ubuntu-latest
    needs: [test, security]
    outputs:
      image: ${{ steps.image-meta.outputs.image }}
    steps:
      - uses: actions/checkout@v3
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Compute image uri
        id: image-meta
        run: echo "image=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}" >> $GITHUB_OUTPUT
      - name: Build and push image
        id: build-image
        env:
          IMAGE_URI: ${{ steps.image-meta.outputs.image }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker build -t $IMAGE_URI . -f Dockerfile
          docker tag $IMAGE_URI $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $IMAGE_URI
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ steps.image-meta.outputs.image }}
          format: table
          exit-code: '0'
          severity: CRITICAL,HIGH

  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.image != ''
    steps:
      - uses: actions/checkout@v3
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
      - env:
          IMAGE: ${{ needs.build.outputs.image }}
        run: |
          kubectl set image deployment/backend api=$IMAGE -n neuromatch-app
          kubectl rollout status deployment/backend -n neuromatch-app
          kubectl get pods -n neuromatch-app -l app=backend

  smoke-test:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.build.outputs.image != ''
    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
      - run: |
          kubectl port-forward -n neuromatch-app service/backend 8080:80 &
          PF_PID=$!
          sleep 5
          curl -f http://localhost:8080/health
          kill $PF_PID

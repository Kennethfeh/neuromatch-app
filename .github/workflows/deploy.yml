name: Build and Deploy

# when to run this workflow

on:
  push:
    branches: [main]
  pull_request:
     branches:  [main]

# Environment variables available to all jobs
env:
   AWS_REGION: us-west-2
   ECR_REPOSITORY: neuromatch-api
   EKS_CLUSTER_NAME: neuromatch-cluster


   jobs:
     # job 1 Run tests
     test:
        name: Run Tests
        runs-on: ubuntu-latest 

      steps:
        - name: checkout code 
          uses: actions/checkout@v3
          with:
            node-version: '18'
            cache: 'npm'


        - name: Install dependencies
          run: npm ci 


        - name: Run linter
          run: npm run lint || echo "No linter figured"

        - name: Run tests 
           run: npm test

        - name: check code coverage 
           run: npm run coverage || echo "No coverage configured"

        # Job 2: Security scan
        Security:
           name: Security Scan 
           runs-on: ubuntu-latest


           steps:
            - name: checkout code
              uses: actions/checkout@v3


            - name: Run Trivy vulnerability scanner 
              uses: aquasecurity/trivy-action@master
              with:
                scan-type: 'fs'
                scan-ref: '.'
                format: 'sarif'
                output: 'trivy-results.sarif'


            - name: Upload Trivy results to github Security
              uses: github/codeql-action/upload-sarif@v2
              with:
                sarif_file: 'trivy-results.sarif'

    # job 3: build and push docker image 
       build:
       name: build Docker image
       runs-on: ubuntu-latest
       needs: [test, security] # only run if test security pass

       # Only build on main branch (not PRs)
       if: github.ref == 'refs'/heads/main'

       outputs:
          image: ${{ steps.build-image.outputs.image }}

      steps:
        - name: Checkout code
          uses: actions/checkout@v3


        - name: Configure AWS credentials 
          uses: aws-actions/configure-aws-credentials@v2
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }} 
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ env.AWS_REGION }}

        -name: Login to Amazon ECR 
           id: build-image 
           env: 
           ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
           IMAGE_TAG: ${{ github.sha }}

        run: |
          # Build Docker image 
            docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
            docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest

            # push to ECR
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
            docker push $ECR_REGISTRY/ECR_REPOSITORY:latest


            # Output for next job 
            echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

           - name: scan image with Trivy
             uses: aquasecurity/trivy-action@master
             with: 
             image-ref: ${{ steps.build-image.outputs.image }}
             format: 'table'
             exit-code: '0' # Don't fail on vulnerabilities (just warn)
             severity: 'CRITICAL,HIGH'

 #  Job 4: Deploy to kubernetes
 deploy:
    name: Deploy to EKS 
    runs-on: ubuntu-latest
    needs: build


    steps:
      - name: Checkout code 
        uses: actions/checkout@v3

     - name: Checkout code
       uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
      aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      aws-region: ${{ env.AWS_REGION }}

    - name: Update kubeconfig
      run: |
      aws eks update-kubeconfig \
      --region ${{env.AWS_REGION }} \
      --name ${{ env.EKS_CLUSTER_NAME }}


    - name: Deploy to Kubernetes 
       env:
       IMAGE: ${{ needs.build.outputs.image }}
       run: |
       # Update image in deployment
       kubectl set image deployment/backend \
       api=$IMAGE \
       -n neuromatch-app 

    # wait for roll out to complete 
    kubectl rollout status deployment/backend -n neuromatch-app 

    - name: verify deployment 
      run |
        kubectl get pods -n neuromatch-app -l app=backend
        kubeclt get deployment backend -n neuromatch-app 


  # job 5: Smoke tests 
  smoke-test:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy


steps:
 - name: Configure AWS credentials 
   uses: aws-actions/configure-aws-credentials@v2
   with:
     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
     aws-secret-access-key: ${{. secrets.AWS_SECRET_ACCESS_KEY }}
     aws-region: ${{ env.AWS_REGION }}
  
  - name: Update kubeconfig
     run: |
     aws eks update-kubeconfig \
        -- region ${{ env.AWS_REGION }} \
        -- name ${{ env.EKS_CLUSTER_NAME }}


  - name: Test health endpoint 
    run: |
    # Get service URL 
    kubectl get service backend -n neuromatch-app 

    # port forward test
    kubectl port-forward -n neuromatch-app service/backend 8080:80 & 
    sleep 5 

    # test health check 

    curl -f http://localhost:8080/health || exit 1 

    echo "health check passed!"
  



        